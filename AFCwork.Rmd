---
title: "AFC_work"
author: "Jett Knight, BI Analyst, OPMI"
output: html_document
date: "2024-11-08"
---

#Setup

```{r setup, include=FALSE}
library(fs)
library(tidyverse)
library(lubridate)
library(DBI)
library(RPostgres)
library(sf)
library(ggspatial)
library(prettymapr)
library(units)
library(opmitools)

options(scipen = 999)
```

#DB Connection

```{r}
user_box <- "jknight2"
user <- "jknight"
user_pgadmin <- "jknight2"

box_link <- paste0("C:/Users/",user_box,"/Box/02 Active Projects/2024 AFC 2.0/Public Rollout Analyses/Tableau/")

con_dmap <-
  dbConnect(
    Postgres(),
    dbname = "dmap_import",
    user = user_pgadmin,
    password = rstudioapi::askForPassword(),
    port = 5432,
    host = "dmap-import-prod.cluster-ro-cw84s0ixvuei.us-east-1.rds.amazonaws.com",
    sslmode = "require"
  )

con_rs <-
  dbConnect(
    Postgres(),
    dbname = "mbta_dw",
    user = user,
    password = rstudioapi::askForPassword(),
    port = 5432,
    host = "opmi-research-server.cluster-csb3ld1kts7u.us-east-1.rds.amazonaws.com",
    sslmode = "require"
  )
```

#Analysis

```{r}
recent_discrepant_taps <- dbGetQuery(con_rs, paste0("SELECT * FROM ridership.afc2_device_location_issues WHERE svc_date >= '2025-02-01'"))
```

```{r}
subway_discrepant_taps <- recent_discrepant_taps %>%
  filter(operator_name == 'Subway')
```

```{r}
correct_subway_taps <- subway_discrepant_taps %>%
  filter(over_150m == 'Lat/Lon within 150m of Displayed Stop Point')

incorrect_subway_taps <- subway_discrepant_taps %>%
  filter(over_150m == 'Lat/Lon Farther than 150m from Displayed Stop Point')

na_taps <- subway_discrepant_taps %>%
  filter(over_150m == 'BMV Trx Missing Lat/Lon')
```

```{r}
table(subway_discrepant_taps$over_150m)
```

```{r}
sort(table(na_taps$stop_name_from_stoppoint))
table(na_taps$stop_name_from_coordinates)
```

